# Generated by Django 4.2 on 2026-02-03 22:54

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0054_auto_update_pool_settled_status'),
    ]

    operations = [
        migrations.CreateModel(
            name='YieldFeatureSnapshot',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('season_label', models.CharField(help_text="e.g., '2025-2026'", max_length=20)),
                ('snapshot_date', models.DateField(help_text='Date features were computed')),
                ('gdd_cumulative', models.DecimalField(blank=True, decimal_places=1, help_text='Growing Degree Days accumulated since season start', max_digits=8, null=True)),
                ('gdd_base_temp_f', models.DecimalField(decimal_places=1, default=55.0, help_text='GDD base temperature (Fahrenheit)', max_digits=5)),
                ('chill_hours_cumulative', models.DecimalField(blank=True, decimal_places=1, help_text='Chill hours (Utah model) accumulated Nov 1 - Mar 1', max_digits=7, null=True)),
                ('chill_portions', models.DecimalField(blank=True, decimal_places=1, help_text='Chill portions (Dynamic model)', max_digits=6, null=True)),
                ('precipitation_cumulative_in', models.DecimalField(blank=True, decimal_places=2, help_text='Cumulative precipitation (inches) since season start', max_digits=7, null=True)),
                ('heat_stress_days', models.IntegerField(blank=True, help_text='Days with max temp > 105F since bloom', null=True)),
                ('frost_events', models.IntegerField(blank=True, help_text='Days with min temp < 32F during critical period', null=True)),
                ('eto_cumulative_in', models.DecimalField(blank=True, decimal_places=2, help_text='Cumulative reference ET (inches) since season start', max_digits=7, null=True)),
                ('ndvi_mean', models.DecimalField(blank=True, decimal_places=3, help_text='Mean NDVI across field from latest satellite detection', max_digits=4, null=True)),
                ('ndvi_trend', models.DecimalField(blank=True, decimal_places=4, help_text='NDVI slope over last 3 months (positive = greening)', max_digits=5, null=True)),
                ('canopy_coverage_pct', models.DecimalField(blank=True, decimal_places=2, help_text='Canopy coverage percentage', max_digits=5, null=True)),
                ('tree_height_avg_m', models.DecimalField(blank=True, decimal_places=2, help_text='Average tree height from LiDAR (meters)', max_digits=5, null=True)),
                ('alternate_bearing_index', models.DecimalField(blank=True, decimal_places=3, help_text='Alternate bearing index (-1 to 1; positive = expecting ON year)', max_digits=4, null=True)),
                ('prior_season_yield_per_acre', models.DecimalField(blank=True, decimal_places=2, help_text='Previous season yield/acre for bearing pattern analysis', max_digits=10, null=True)),
                ('tree_age_years', models.IntegerField(blank=True, null=True)),
                ('trees_per_acre', models.DecimalField(blank=True, decimal_places=2, max_digits=8, null=True)),
                ('irrigation_type', models.CharField(blank=True, max_length=20)),
                ('soil_type', models.CharField(blank=True, max_length=30)),
                ('rootstock_vigor', models.CharField(blank=True, max_length=20)),
                ('organic_status', models.CharField(blank=True, max_length=20)),
                ('soil_awc', models.DecimalField(blank=True, decimal_places=3, help_text='Available water capacity from SSURGO', max_digits=5, null=True)),
                ('soil_clay_pct', models.DecimalField(blank=True, decimal_places=1, max_digits=5, null=True)),
                ('soil_ph', models.DecimalField(blank=True, decimal_places=2, max_digits=4, null=True)),
                ('irrigation_applied_in', models.DecimalField(blank=True, decimal_places=2, help_text='Cumulative irrigation applied (inches) since season start', max_digits=7, null=True)),
                ('total_nitrogen_lbs_per_acre', models.DecimalField(blank=True, decimal_places=2, help_text='Cumulative N applied this season (lbs/acre)', max_digits=7, null=True)),
                ('feature_vector', models.JSONField(blank=True, default=dict, help_text='Complete feature dict for model consumption')),
                ('data_quality', models.JSONField(blank=True, default=dict, help_text='Per-feature availability tracking and completeness_pct')),
                ('warnings', models.JSONField(blank=True, default=list, help_text='Human-readable data quality warnings')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('field', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='yield_feature_snapshots', to='api.field')),
            ],
            options={
                'verbose_name': 'Yield Feature Snapshot',
                'verbose_name_plural': 'Yield Feature Snapshots',
                'ordering': ['-snapshot_date'],
            },
        ),
        migrations.AddField(
            model_name='farm',
            name='cimis_station_id',
            field=models.CharField(blank=True, help_text="Nearest CIMIS weather station ID (e.g., '152' for Oxnard). Used for yield forecast climate features.", max_length=20),
        ),
        migrations.CreateModel(
            name='YieldForecast',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('season_label', models.CharField(help_text="e.g., '2025-2026'", max_length=20)),
                ('forecast_date', models.DateField(help_text='Date the forecast was generated')),
                ('predicted_yield_per_acre', models.DecimalField(decimal_places=2, help_text='Point estimate yield per acre', max_digits=10)),
                ('predicted_total_yield', models.DecimalField(decimal_places=2, help_text='Total field yield = yield_per_acre * harvestable_acres', max_digits=12)),
                ('yield_unit', models.CharField(choices=[('bins', 'Bins'), ('lbs', 'Pounds'), ('tons', 'Tons'), ('cartons', 'Cartons')], default='bins', max_length=10)),
                ('harvestable_acres', models.DecimalField(decimal_places=2, help_text='Acres used for total yield calculation', max_digits=10)),
                ('confidence_level', models.DecimalField(decimal_places=2, default=0.8, help_text='Confidence level (e.g., 0.80 for 80%)', max_digits=4)),
                ('lower_bound_per_acre', models.DecimalField(decimal_places=2, help_text='Lower bound of confidence interval (yield/acre)', max_digits=10)),
                ('upper_bound_per_acre', models.DecimalField(decimal_places=2, help_text='Upper bound of confidence interval (yield/acre)', max_digits=10)),
                ('forecast_method', models.CharField(choices=[('historical_avg', 'Historical Average'), ('climate_adjusted', 'Climate-Adjusted Historical'), ('bearing_adjusted', 'Bearing-Adjusted (no climate)'), ('crop_baseline', 'Crop Baseline (insufficient field data)'), ('regression', 'Linear Regression'), ('ml_ensemble', 'ML Ensemble')], default='historical_avg', max_length=30)),
                ('model_version', models.CharField(blank=True, help_text='Model version identifier', max_length=50)),
                ('feature_importance', models.JSONField(blank=True, default=dict, help_text='Dict of feature_name -> importance_score')),
                ('climate_adjustment_factor', models.DecimalField(blank=True, decimal_places=3, help_text='Multiplier applied for climate conditions (1.0 = normal)', max_digits=5, null=True)),
                ('data_completeness_pct', models.DecimalField(blank=True, decimal_places=1, help_text='Percentage of possible features that had data', max_digits=5, null=True)),
                ('degradation_warnings', models.JSONField(blank=True, default=list, help_text='Warnings about missing data that affected the forecast')),
                ('actual_yield_per_acre', models.DecimalField(blank=True, decimal_places=2, max_digits=10, null=True)),
                ('actual_total_yield', models.DecimalField(blank=True, decimal_places=2, max_digits=12, null=True)),
                ('forecast_error_pct', models.DecimalField(blank=True, decimal_places=2, help_text='Absolute % error = |actual - predicted| / actual * 100', max_digits=6, null=True)),
                ('status', models.CharField(choices=[('draft', 'Draft'), ('published', 'Published'), ('superseded', 'Superseded')], default='draft', max_length=20)),
                ('notes', models.TextField(blank=True, help_text='Manual notes or adjustments')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='yield_forecasts_created', to=settings.AUTH_USER_MODEL)),
                ('feature_snapshot', models.ForeignKey(blank=True, help_text='Feature snapshot used to generate this forecast', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='forecasts', to='api.yieldfeaturesnapshot')),
                ('field', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='yield_forecasts', to='api.field')),
            ],
            options={
                'verbose_name': 'Yield Forecast',
                'verbose_name_plural': 'Yield Forecasts',
                'ordering': ['-forecast_date', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='SoilSurveyData',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('mukey', models.CharField(blank=True, help_text='Map Unit Key from SSURGO', max_length=30)),
                ('musym', models.CharField(blank=True, help_text='Map Unit Symbol', max_length=10)),
                ('muname', models.CharField(blank=True, help_text='Map Unit Name', max_length=200)),
                ('texture_class', models.CharField(blank=True, help_text="USDA texture class (e.g., 'Sandy Loam')", max_length=50)),
                ('clay_pct', models.DecimalField(blank=True, decimal_places=1, help_text='Clay percentage', max_digits=5, null=True)),
                ('sand_pct', models.DecimalField(blank=True, decimal_places=1, help_text='Sand percentage', max_digits=5, null=True)),
                ('silt_pct', models.DecimalField(blank=True, decimal_places=1, help_text='Silt percentage', max_digits=5, null=True)),
                ('organic_matter_pct', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('ph', models.DecimalField(blank=True, decimal_places=2, help_text='Soil pH (1:1 water)', max_digits=4, null=True)),
                ('cec', models.DecimalField(blank=True, decimal_places=1, help_text='Cation Exchange Capacity (meq/100g)', max_digits=6, null=True)),
                ('available_water_capacity', models.DecimalField(blank=True, decimal_places=3, help_text='Available water capacity (inches per inch of soil)', max_digits=5, null=True)),
                ('drainage_class', models.CharField(blank=True, help_text="e.g., 'Well drained'", max_length=50)),
                ('depth_to_restrictive_layer_cm', models.IntegerField(blank=True, null=True)),
                ('ksat', models.DecimalField(blank=True, decimal_places=3, help_text='Saturated hydraulic conductivity (um/s)', max_digits=8, null=True)),
                ('fetched_at', models.DateTimeField(auto_now=True)),
                ('raw_response', models.JSONField(blank=True, default=dict, help_text='Full SSURGO API response')),
                ('field', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='soil_survey', to='api.field')),
            ],
            options={
                'verbose_name': 'Soil Survey Data',
                'verbose_name_plural': 'Soil Survey Data',
            },
        ),
        migrations.CreateModel(
            name='ExternalDataSource',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('source_type', models.CharField(choices=[('ssurgo', 'SSURGO Soil Survey'), ('cimis', 'CIMIS Weather'), ('openweather', 'OpenWeatherMap'), ('satellite_ndvi', 'Satellite NDVI'), ('prism', 'PRISM Climate'), ('usda_nass', 'USDA NASS')], max_length=30)),
                ('name', models.CharField(help_text='Human-readable name for this integration', max_length=200)),
                ('api_endpoint', models.URLField(blank=True, help_text='API base URL')),
                ('last_sync_at', models.DateTimeField(blank=True, null=True)),
                ('last_sync_status', models.CharField(choices=[('pending', 'Pending'), ('syncing', 'Syncing'), ('success', 'Success'), ('error', 'Error')], default='pending', max_length=20)),
                ('last_sync_error', models.TextField(blank=True)),
                ('records_synced', models.IntegerField(default=0)),
                ('config', models.JSONField(blank=True, default=dict, help_text='Source-specific configuration')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('company', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='external_data_sources', to='api.company')),
            ],
            options={
                'verbose_name': 'External Data Source',
                'verbose_name_plural': 'External Data Sources',
                'ordering': ['-updated_at'],
            },
        ),
        migrations.AddIndex(
            model_name='yieldforecast',
            index=models.Index(fields=['field', 'season_label', '-forecast_date'], name='api_yieldfo_field_i_57da69_idx'),
        ),
        migrations.AddIndex(
            model_name='yieldforecast',
            index=models.Index(fields=['status', 'season_label'], name='api_yieldfo_status_ebb5d9_idx'),
        ),
        migrations.AddIndex(
            model_name='yieldfeaturesnapshot',
            index=models.Index(fields=['field', 'season_label', 'snapshot_date'], name='api_yieldfe_field_i_88d298_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='yieldfeaturesnapshot',
            unique_together={('field', 'season_label', 'snapshot_date')},
        ),
        migrations.AlterUniqueTogether(
            name='externaldatasource',
            unique_together={('company', 'source_type')},
        ),
    ]
